<!-- Fixed Navigation - Corrected date calculation for Jekyll 3.8 -->
{% comment %}
Fixed date calculation method that works reliably with Jekyll 3.8
Uses a simpler approach to count recent posts
{% endcomment %}

<!-- Count recent games from site.posts (last 2 weeks) -->
{% assign new_games_count = 0 %}
{% assign current_timestamp = 'now' | date: '%s' | plus: 0 %}
{% assign two_weeks_seconds = 1209600 %}
{% assign threshold_timestamp = current_timestamp | minus: two_weeks_seconds %}

{% if site.posts %}
  {% for post in site.posts limit: 10 %}
    {% if post.date %}
      {% assign post_timestamp = post.date | date: '%s' | plus: 0 %}
      {% if post_timestamp >= threshold_timestamp %}
        {% assign new_games_count = new_games_count | plus: 1 %}
      {% endif %}
    {% endif %}
  {% endfor %}
{% endif %}

<!-- Count recent blog posts from site.blog_posts (last 2 weeks) -->
{% assign new_blogs_count = 0 %}
{% if site.blog_posts %}
  {% for post in site.blog_posts limit: 10 %}
    {% if post.date %}
      {% assign post_timestamp = post.date | date: '%s' | plus: 0 %}
      {% if post_timestamp >= threshold_timestamp %}
        {% assign new_blogs_count = new_blogs_count | plus: 1 %}
      {% endif %}
    {% endif %}
  {% endfor %}
{% endif %}

<!-- Alternative: Simple recent post check (fallback) -->
{% assign has_recent_games = false %}
{% assign has_recent_blogs = false %}

{% if site.posts.first.date %}
  {% assign days_since_last_game = 'now' | date: '%s' | minus: site.posts.first.date | date: '%s' | divided_by: 86400 %}
  {% if days_since_last_game <= 14 %}
    {% assign has_recent_games = true %}
  {% endif %}
{% endif %}

{% if site.blog_posts.first.date %}
  {% assign days_since_last_blog = 'now' | date: '%s' | minus: site.blog_posts.first.date | date: '%s' | divided_by: 86400 %}
  {% if days_since_last_blog <= 14 %}
    {% assign has_recent_blogs = true %}
  {% endif %}
{% endif %}

<nav class="container navbar navbar-expand-lg navbar-light bg-transparent">
  <a class="navbar-brand" href={{"/" | relative_url}}>üïπÔ∏èsublevelgames</a>
  <button
    class="navbar-toggler"
    type="button"
    data-toggle="collapse"
    data-target="#navbarSupportedContent"
    aria-controls="navbarSupportedContent"
    aria-expanded="false"
    aria-label="Toggle navigation"
  >
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <!-- Í≤ÄÏÉâ Ìèº -->
    <div class="search-wrapper mr-auto">
      <input type="text" id="search-input" class="form-control" placeholder="Search games...">
      <ul id="results-container" class="search-results"></ul>
    </div>

    <ul class="navbar-nav ml-auto">
      <li class="nav-item">
        <a class="nav-link" href={{"/" | relative_url}}>
          Games
          {% if new_games_count > 0 %}
            <small class="text-success font-weight-bold">({{ new_games_count }})</small>
          {% elsif has_recent_games %}
            <small class="text-success font-weight-bold">(1)</small>
          {% endif %}
          <span class="sr-only">(current)</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href={{"/blogs/" | relative_url}}>
          Blogs
          {% if new_blogs_count > 0 %}
            <small class="text-primary font-weight-bold">({{ new_blogs_count }})</small>
          {% elsif has_recent_blogs %}
            <small class="text-primary font-weight-bold">(1)</small>
          {% endif %}
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href={{"/tags/" | relative_url}}>Tags</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href={{"/about/" | relative_url}}>About</a>
      </li>
    </ul>
  </div>

  <!-- Simple Jekyll Search Ïä§ÌÅ¨Î¶ΩÌä∏ -->
  <script src="https://unpkg.com/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var sjs = SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('results-container'),
        json: '{{ "/search.json" | relative_url }}',
        searchResultTemplate: '<li><a href="{url}">{title}</a> <small>{tags}</small></li>',
        noResultsText: 'No results found',
        limit: 10,
        fuzzy: false
      });
    });
  </script>
</nav>

<style>
/* Counter styling */
.nav-link small {
  font-size: 0.75rem;
  vertical-align: top;
  margin-left: 0.25rem;
  display: inline-block;
  border-radius: 8px;
  padding: 0.1rem 0.3rem;
  line-height: 1.2;
}

.nav-link:hover small {
  transform: scale(1.05);
  transition: transform 0.2s ease;
}

@media (max-width: 768px) {
  .nav-link small {
    font-size: 0.7rem;
    margin-left: 0.2rem;
    padding: 0.05rem 0.2rem;
  }
}
</style>

<!-- Enhanced Debug Information -->
<script>
(function() {
  // Only log on main pages, not every pagination
  var shouldLog = window.location.pathname === '/' || 
                  window.location.pathname === '/blogs/' || 
                  window.location.pathname.includes('/page') ||
                  !window.navigationDebugLogged;
  
  if (shouldLog) {
    console.log('üéÆ Fixed Navigation Debug:');
    console.log('Current URL:', window.location.pathname);
    console.log('Games (site.posts):', {{ site.posts.size | default: 0 }});
    console.log('Blogs (site.blog_posts):', {{ site.blog_posts.size | default: 0 }});
    console.log('Current timestamp:', {{ current_timestamp }});
    console.log('Threshold timestamp:', {{ threshold_timestamp }});
    console.log('New games count:', {{ new_games_count }});
    console.log('New blogs count:', {{ new_blogs_count }});
    console.log('Has recent games (fallback):', {{ has_recent_games }});
    console.log('Has recent blogs (fallback):', {{ has_recent_blogs }});
    
    {% if site.posts.first %}
    console.log('Latest game:', '{{ site.posts.first.title }}', '{{ site.posts.first.date | date: "%Y-%m-%d" }}');
    {% endif %}
    {% if site.blog_posts.first %}
    console.log('Latest blog:', '{{ site.blog_posts.first.title }}', '{{ site.blog_posts.first.date | date: "%Y-%m-%d" }}');
    {% endif %}
    
    // Manual date check
    var now = new Date();
    var twoWeeksAgo = new Date(now.getTime() - (14 * 24 * 60 * 60 * 1000));
    console.log('JavaScript check - Two weeks ago:', twoWeeksAgo.toISOString().split('T')[0]);
    
    {% if site.posts.first %}
    var lastGameDate = new Date('{{ site.posts.first.date | date: "%Y-%m-%d" }}');
    console.log('Last game date:', lastGameDate.toISOString().split('T')[0]);
    console.log('Is game recent?', lastGameDate >= twoWeeksAgo);
    {% endif %}
    
    {% if site.blog_posts.first %}
    var lastBlogDate = new Date('{{ site.blog_posts.first.date | date: "%Y-%m-%d" }}');
    console.log('Last blog date:', lastBlogDate.toISOString().split('T')[0]);
    console.log('Is blog recent?', lastBlogDate >= twoWeeksAgo);
    {% endif %}
    
    window.navigationDebugLogged = true;
  }
})();
</script>