<!-- Simple Image Popup V3 -->
<div id="image-popup-overlay" class="image-popup-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); z-index: 9999; opacity: 0; transition: opacity 0.3s ease; cursor: pointer;">
  <div class="image-popup-container" style="position: relative; max-width: 95vw; max-height: 95vh; display: flex; flex-direction: column; align-items: center; cursor: default; margin: auto;">
    <button class="image-popup-close" style="position: absolute; top: -50px; right: 0; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; font-weight: bold; color: #333; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; z-index: 10001;" aria-label="Close popup">&times;</button>
    <img id="image-popup-img" class="image-popup-img" src="" alt="" style="max-width: 100%; max-height: 85vh; object-fit: contain; border-radius: 8px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);">
    <div class="image-popup-caption" style="margin-top: 15px; padding: 10px 20px; background: rgba(0, 0, 0, 0.8); color: white; border-radius: 6px; font-size: 14px; text-align: center; max-width: 100%; word-wrap: break-word; display: none;"></div>
  </div>
</div>

<style>
/* Image hover effect */
.post-content img {
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  border-radius: 4px;
}

.post-content img:hover {
  transform: scale(1.02);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
}

/* Prevent body scroll when popup is open */
body.popup-open {
  overflow: hidden;
}

/* Close button hover */
.image-popup-close:hover {
  background: rgba(255, 255, 255, 1) !important;
  transform: scale(1.1);
}

/* Responsive */
@media (max-width: 768px) {
  .image-popup-close {
    top: -40px !important;
    width: 35px !important;
    height: 35px !important;
    font-size: 20px !important;
  }
}
</style>

<script type="text/javascript">
console.log('üöÄ Loading Simple Image Popup V3...');

// Wait for DOM to be ready
function initSimplePopup() {
  console.log('üñºÔ∏è Initializing Simple Image Popup...');
  
  // Get popup elements
  var overlay = document.getElementById('image-popup-overlay');
  var popupImg = document.getElementById('image-popup-img');
  var closeBtn = document.querySelector('.image-popup-close');
  var caption = document.querySelector('.image-popup-caption');
  var container = document.querySelector('.image-popup-container');
  
  console.log('Elements check:', {
    overlay: !!overlay,
    popupImg: !!popupImg,
    closeBtn: !!closeBtn,
    caption: !!caption,
    container: !!container
  });
  
  if (!overlay || !popupImg || !closeBtn || !caption) {
    console.log('‚ùå Popup elements missing, retrying in 500ms...');
    setTimeout(initSimplePopup, 500);
    return;
  }
  
  // Find images
  var images = document.querySelectorAll('.post-content img, article img, .content img');
  console.log('üì∏ Found ' + images.length + ' images');
  
  if (images.length === 0) {
    console.log('‚ùå No images found, retrying in 500ms...');
    setTimeout(initSimplePopup, 500);
    return;
  }
  
  // Setup each image
  for (var i = 0; i < images.length; i++) {
    setupImage(images[i], i);
  }
  
  // Setup popup controls
  setupControls(overlay, closeBtn, container);
  
  console.log('‚úÖ Simple popup initialized successfully!');
}

function setupImage(img, index) {
  console.log('Setting up image ' + (index + 1) + ':', img.src);
  
  // Mark as enabled
  img.setAttribute('data-popup-enabled', 'true');
  img.style.cursor = 'pointer';
  
  // Add click handler
  img.onclick = function(e) {
    console.log('üì∏ Image clicked:', this.src);
    e.preventDefault();
    e.stopPropagation();
    
    openPopup(this);
  };
  
  // Add touch handler for mobile
  img.ontouchend = function(e) {
    console.log('üì± Image touched:', this.src);
    e.preventDefault();
    e.stopPropagation();
    
    openPopup(this);
  };
}

function openPopup(imgElement) {
  console.log('üîç Opening popup for:', imgElement.src);
  
  var overlay = document.getElementById('image-popup-overlay');
  var popupImg = document.getElementById('image-popup-img');
  var caption = document.querySelector('.image-popup-caption');
  
  if (!overlay || !popupImg) {
    console.log('‚ùå Cannot open popup - elements missing');
    return;
  }
  
  // Set image
  popupImg.src = imgElement.src;
  popupImg.alt = imgElement.alt || 'Image';
  
  // Set caption
  var captionText = imgElement.alt || imgElement.title || '';
  if (captionText.trim()) {
    caption.textContent = captionText;
    caption.style.display = 'block';
  } else {
    caption.style.display = 'none';
  }
  
  // Show popup
  document.body.classList.add('popup-open');
  overlay.style.display = 'flex';
  overlay.style.alignItems = 'center';
  overlay.style.justifyContent = 'center';
  
  // Fade in
  setTimeout(function() {
    overlay.style.opacity = '1';
  }, 10);
  
  console.log('‚úÖ Popup opened');
}

function closePopup() {
  console.log('‚ùå Closing popup...');
  
  var overlay = document.getElementById('image-popup-overlay');
  if (!overlay) return;
  
  // Fade out
  overlay.style.opacity = '0';
  
  // Hide after animation
  setTimeout(function() {
    overlay.style.display = 'none';
    document.body.classList.remove('popup-open');
  }, 300);
  
  console.log('‚úÖ Popup closed');
}

function setupControls(overlay, closeBtn, container) {
  // Close button
  closeBtn.onclick = function(e) {
    console.log('üî¥ Close button clicked');
    e.stopPropagation();
    closePopup();
  };
  
  // Click outside to close
  overlay.onclick = function(e) {
    if (e.target === overlay) {
      console.log('üî¥ Clicked outside popup');
      closePopup();
    }
  };
  
  // Prevent container clicks from closing
  if (container) {
    container.onclick = function(e) {
      e.stopPropagation();
    };
  }
  
  // ESC key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && overlay.style.opacity === '1') {
      console.log('üî¥ ESC key pressed');
      closePopup();
    }
  });
}

// Initialize immediately if DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initSimplePopup);
} else {
  initSimplePopup();
}

// Backup initializations
window.addEventListener('load', function() {
  setTimeout(initSimplePopup, 100);
});

setTimeout(initSimplePopup, 1000);
setTimeout(initSimplePopup, 2000);

// Global functions for debugging
window.initSimplePopup = initSimplePopup;
window.openImagePopup = openPopup;
window.closeImagePopup = closePopup;

window.debugImages = function() {
  console.log('=== Image Debug ===');
  var images = document.querySelectorAll('img');
  console.log('Total images:', images.length);
  
  images.forEach(function(img, i) {
    console.log('Image ' + i + ':', {
      src: img.src,
      popupEnabled: img.getAttribute('data-popup-enabled'),
      cursor: img.style.cursor,
      onclick: !!img.onclick
    });
  });
  
  // Force setup all images
  images.forEach(function(img, i) {
    if (!img.getAttribute('data-popup-enabled')) {
      console.log('Setting up missed image ' + i);
      setupImage(img, i);
    }
  });
};

console.log('‚úÖ Simple Image Popup V3 script loaded');
</script>